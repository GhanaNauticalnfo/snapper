name: Build & Deploy (matrix)

on:
  push:
    branches: [develop, test, main]     # dev → develop  •  test → test  •  prod → main
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  deploy:
    strategy:
      matrix:
        include:
          # ────────── dev ──────────
          - app: api
            env: dev
            branch_match: develop
          - app: admin
            env: dev
            branch_match: develop
          - app: frontend
            env: dev
            branch_match: develop
          # ────────── test ─────────
          - app: api
            env: test
            branch_match: test
          - app: admin
            env: test
            branch_match: test
          - app: frontend
            env: test
            branch_match: test
          # ────────── prod ─────────
          - app: api
            env: prod
            branch_match: main
          - app: admin
            env: prod
            branch_match: main
          - app: frontend
            env: prod
            branch_match: main

    # Run only the rows that match the pushed branch
    if: ${{ github.ref_name == matrix.branch_match }}

    uses: ./.github/workflows/nx-app-deploy.yml
    with:
      app_name:    ${{ matrix.app }}
      environment: ${{ matrix.env }}
