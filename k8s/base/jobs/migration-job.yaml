apiVersion: batch/v1
kind: Job
metadata:
  name: ghanawaters-api-migrations
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300  # Auto-delete after 5 minutes
  template:
    spec:
      containers:
      - name: migrations
        image: ghananauticalinfo/ghanawaters-api:latest  # Will be patched in overlays
        command: ["/bin/sh", "-c"]
        args:
          - |
            cd /app
            echo "Running migrations for ${NODE_ENV} environment..."
            npm run migration:run
        env:
        - name: NODE_ENV
          value: "prod"  # Will be patched in overlays
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: ghanawaters-postgres-secret
              key: DATABASE_URL
      restartPolicy: Never
  backoffLimit: 3